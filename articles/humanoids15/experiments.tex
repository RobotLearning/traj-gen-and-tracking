\section{Experiments}\label{experiments}

% is this necessary?
%\subsection{Experimental Setup}

In this section, we demonstrate the effectiveness of the algorithm presented in Section~\ref{algorithm} in the context of movement primitive learning for optimal striking motions. We consider two hitting tasks: putting in golf and ball-hitting in table tennis. In the first task the trajectory and the extracted movement primitives are assigned in operational, i.e. Cartesian space, whereas for the second task we generate these primitives in joint space, one for each joint of the robot. A low-gain feedback law is calculated in both cases using LQR with the linearized dynamics \eqref{discreteLTV} which transfers the weight updates of the DMPs to motor commands. The robustness that comes with the LQR feedback law and the DMP framework is an asset that strengthens the industrial applicability of our approach outside of the tested platforms.

We assume that the reference trajectories are \emph{feasible}, i.e. that it is possible to follow them arbitrarily well. If this assumption does not hold, then one can enforce feasibility by redesigning the basis functions $\basis(t)$ of the DMPs so as to filter out the nonsmooth parts of the trajectory adequately.

\subsection{Verification and Comparisons in Simulated Putting}

%Putting is a simple and natural domain for testing ILC algorithms because it allows a robot to apply ILC to actuate few degrees of freedom (typically the end joint) while having the dynamical effects from the other links act as disturbances. This kind of learning in underactuated dynamical systems can act as a scalable interface to more complex hitting tasks in the full-joint space of robots with high DoFs. Here we provide only a simple example to illustrate such \emph{scalable} learning.
%By learning the causal map of the disturbances acting on the robot (i.e. a graphical model) one can iteratively construct increasingly sophisticated controllers that are cognizant of the causal relationships between the joints and the disturbances. 

Putting is a simple and natural domain for testing ILC algorithms, in particular we consider it as a scalable interface to more complex hitting tasks with high DoF robots. We illustrate in Figure~\ref{putting1} a simplified simulation of a two-link planar arm with two revolute joints hitting a golf ball on the ground. We can imagine that a golf stick is attached to the end-effector at the second joint. We assume that we have available a circular reference trajectory that intercepts the ball with a desired velocity of $1.8$ m/s. This lets us account for the masses of the arm and the ball as well as a simulated kinetic friction of $\mu = 0.6$ between the golf ball and the ground. Good putting trajectories can be shown easily by expert humans or recorded via kinesthetic teach-in. 

In order to simulate learning with ILC, we assume that there is a model mismatch due to the motor inertia of both joints. We give the motor inertia a Gaussian distributed disturbance with zero mean and a variance of $0.05$, while the actual values of the motor inertia are $0.15$ and $0.12$ respectively. With these random disturbances we can construct error bars for $\alg$ and also test for the robustness of the proposed method.

\begin{figure}[ht]
\centering
\subfloat[Initial attempt]{%
\includegraphics[width=0.5\linewidth]{putting0.eps}
\label{fig:subfig1}}
\subfloat[Final trajectory]{%
\includegraphics[width=0.5\linewidth]{putting1.eps}
\label{fig:subfig2}}
\caption{Robot arm must follow the assigned reference trajectory precisely in order to hit the ball with a desired velocity at the desired time. The reference trajectory is shown as a blue dashed curve. We can see in Fig.~\ref{fig:subfig1} that the initial attempt falls short of the reference trajectory. ILC then modifies the weights of the DMP to compensate for the modeling errors. In Fig.~\ref{fig:subfig2} the reference trajectory is executed perfectly. The ball will then approach the hole, shown as a thick blue line at a distance of 0.5 meters, with approximately zero velocity.} 
\label{putting1} 
\end{figure}

The iterations of \emph{wILC} are shown in Figure~\ref{wILCTrajectoryPutting}. Learning takes place in the joint space of the robot, since the matrix $\vec{F}_{w}$ is constructed using the nominal dynamics model \eqref{dynamics} in joint space. The full dynamics $\dynamics(\joint,\dot{\joint},\sysInput)$ involves the nonlinear effects from both links. We can see how initially the inertial disturbances of the motors prevent the end-effector from following the trajectory precisely. The following iterations show how ILC compensates for such an effect and in the last iteration the ball is given the desired velocity to reach the hole. We compare the approach with \emph{REPS} and \emph{PI$^{2}$} in Figure~\ref{wILCTrajectoryPutting} by plotting the RMS-error of the iterations with each algorithm. The error bars indicate one standard deviation within $10$ trials with different inertial mismatches. Notice that these stochastic approaches take much longer to converge.

% Compare alternative methods, gradient descent, etc.
% table shows that $R = 0$, $Q = I$ appears to be optimal in this case.

\begin{figure}
\center
%\includegraphics[scale=0.50]{comparison.eps}
\newlength\figureheight 
\newlength\figurewidth 
\setlength\figureheight{6cm}  
\setlength\figurewidth{6cm} 
\scalebox{1.0}{\input{Pictures/wILC.tikz}}
\caption{Convergence of $\alg$ to the reference putting trajectory. Convergence is quadratic for the simulated scenario where we have unknown inertial disturbances acting on the motors. Note the slow and unstable performance of the other stochastic RL algorithms.}
\label{wILCTrajectoryPutting}
\end{figure}

\subsection{Application in Table Tennis}

% hitting is not at the end of the trajectory

As a second and more complex task, we consider table tennis where we are interested in generating and executing accurate ball-hitting motions. For the robotic table tennis task we are using a seven degree of freedom (DoF) torque-controlled Barrett WAM arm capable of high speeds up to X rad/sec. A standard size racket (16 cm diameter) is mounted on the end-effector of the arm as can be seen in Figure~\ref{robot}. A vision system consisting of four cameras hanging from the ceiling around each corner of the table is used for tracking the ball \cite{Lampert12}. The orange ball is tracked  visually with a sampling rate of 60 Hz and filtered with an extended Kalman filter that accounts for some of the bouncing behavior of the ball and air drag effects. The table and the tennis balls are in accordance with the International Table Tennis Federation (ITTF) rules.

A ball launcher (see Figure~\ref{ballgun}) is available to throw balls accurately to a fixed position in Cartesian space to the forehand of the robot. The incoming ball arrives with low-variability in desired positions and higher-variability in ball velocities. The whole area to be covered amounts to about 1 m$^2$ circular region in front of the initial forehand gesture of the robot. This allows us to avoid the singularities of the robot. Any ball that appears outside of this circular \emph{feasible} region will not be hit.

When the visual system provides a trajectory of the robot that coincides with the feasible region in Cartesian space, the system has to come up with a trajectory that specifies how, where and when to intersect the incoming ball trajectory. Desired Cartesian position, velocity and orientation of the racket translates in joint space to the specification of 14 parameters: 7 joint angles and 7 joint velocities of the robot arm. Along with the desired hitting time (or the time until impact), these 15 parameters are used to train 7 joint space DMPs that corresponds to the desired reference trajectory in Cartesian space. These movement primitives are synchronized with the same phase \eqref{phase}.

% maybe work on this kinesthetic teach-in paragraph more
In order to generate feasible reference trajectories that account for the variation in incoming ball position and velocity, we used kinesthetic teach-in on the robot to generate successful hitting motions, i.e. those that can hit the ball to the opponent's court. Using the successful examples we trained a probabilistic model $p(\weights|\state_b)$ given ball positions $\state_b$ using weighted regression. Weighting can be put in various ways and we opted for a weighting which put a higher reward on the fast strikes that landed on the edges. The generated DMPs of the model are guaranteed to be safe because these movements lie within the convex combination of demonstrations. 
% Katharina - Hence, the system will not encounter joint limits or hit the table.

% scale dmps if provided with better estimation data of ball position and velocity. dmps as opposed to control inputs or even trajectories can be easily extended to allow for this. 

% From Katharina's paper:
%the position, velocity and orientation of the racket can be computed analytically based on the state of the system and the target on the opponents court.
%These task space parameters can also be converted into joint space parameters using inverse kinematics

\begin{figure}
\center
\includegraphics[scale=0.05, angle= 180]{ballgun.jpg}			
\caption{Robotic table tennis setup with the ball-launcher throwing balls to the robot}
\label{ballgun}
\end{figure}

The attached video shows the improvement achieved after using our algorithm $\alg$. In order to apply our method to a given reference trajectory, we use the mode of the empirical distribution $p(\weights,\state_b) = p(\weights|\state_b)p(\state_b)$ as the weights of our initial movement primitive. The convergence of the trajectories over the iteration domain are shown in Cartesian space in Figure~\ref{wILCTrajectoryTTCartesian}. Hard-to-model dynamical effects such as friction and stiction forces can be learned easily with our approach.

Comparisons to episodic-RL algorithms \emph{REPS} and \emph{PI$^{2}$} in Figure~\ref{ttComparison} illustrate the benefits of our approach, especially the faster convergence and increased accuracy of the proposed method. Some examples of the generated trajectories for the joints 5, 6 and 7 are given in Figure~\ref{wILCTrajectoryTT}. 

\begin{figure}
\center
%\includegraphics[scale=0.50]{comparison.eps}
\scalebox{1.0}{\input{Pictures/ilc.tikz}}
\caption{Convergence of $\alg$ to the reference table tennis trajectory in Cartesian space.}
\label{wILCTrajectoryTTCartesian}
\end{figure}

\begin{figure}
\center
%\includegraphics[scale=0.50]{comparison.eps}
\scalebox{1.0}{\input{Pictures/ilc.tikz}}
\caption{Convergence of $\alg$ to the reference table tennis trajectory for the joints 5, 6 and 7}
\label{wILCTrajectoryTT}
\end{figure}

\begin{figure}
\begingroup
%\tikzset{every picture/.style={scale=0.8}}%
\scalebox{0.5}{\input{comparisonPutting.tex}}
\endgroup
\caption{The log-scale plot of convergence of \emph{wILC}. Note the slow convergence of the other stochastic RL algorithms.}
\label{ttComparison}
\end{figure}